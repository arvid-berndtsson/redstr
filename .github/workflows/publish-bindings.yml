name: Publish Bindings

on:
  workflow_run:
    workflows: ["Publish to crates.io"]
    types:
      - completed

permissions:
  contents: read

jobs:
  verify-version-sync:
    name: Verify version sync
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Validate package versions
        run: |
          WORKSPACE_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          NODE_VERSION=$(node -p "require('./bindings/node/package.json').version")
          PYTHON_VERSION=$(python - <<'PY'
          import pathlib
          import re
          text = pathlib.Path("bindings/python/pyproject.toml").read_text()
          match = re.search(r'^version = "(.*)"$', text, flags=re.M)
          print(match.group(1))
          PY
          )

          echo "Workspace version: ${WORKSPACE_VERSION}"
          echo "Node version:      ${NODE_VERSION}"
          echo "Python version:    ${PYTHON_VERSION}"

          if [ "${WORKSPACE_VERSION}" != "${NODE_VERSION}" ] || [ "${WORKSPACE_VERSION}" != "${PYTHON_VERSION}" ]; then
            echo "Version mismatch detected. Align Cargo.toml, bindings/node/package.json, and bindings/python/pyproject.toml."
            exit 1
          fi

  publish-npm:
    name: Publish npm package
    needs: verify-version-sync
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install dependencies
        working-directory: bindings/node
        run: npm install --include=dev

      - name: Verify npm CLI version for trusted publishing
        working-directory: bindings/node
        run: |
          NPM_VERSION=$(npm --version)
          echo "npm version: ${NPM_VERSION}"
          node -e "const v=process.argv[1].split('.').map(Number); const min=[11,5,1]; const ok=v[0]>min[0] || (v[0]===min[0] && (v[1]>min[1] || (v[1]===min[1] && v[2]>=min[2]))); if(!ok){console.error('npm >= 11.5.1 is required for trusted publishing'); process.exit(1)}" "${NPM_VERSION}"

      - name: Build native bindings
        working-directory: bindings/node
        run: npm run build

      - name: Verify npm package contains native binary
        working-directory: bindings/node
        run: |
          npm pack --json --dry-run > pack.json
          node -e "const fs=require('fs'); const pack=JSON.parse(fs.readFileSync('pack.json','utf8'))[0]; const hasNode=(pack.files||[]).some(f=>String(f.path||'').endsWith('.node')); if(!hasNode){console.error('npm package is missing native .node binary'); process.exit(1)}; console.log('Verified native binary in package tarball');"

      - name: Verify OIDC token availability
        working-directory: bindings/node
        run: |
          if [ -z "${ACTIONS_ID_TOKEN_REQUEST_URL}" ] || [ -z "${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" ]; then
            echo "OIDC token request env vars are missing. Ensure job has id-token: write permission."
            exit 1
          fi

      - name: Publish to npm
        working-directory: bindings/node
        run: npm publish --access public --provenance --ignore-scripts

  build-python:
    name: Build Python dist
    needs: verify-version-sync
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install maturin
        run: pip install maturin

      - name: Build wheel and sdist
        working-directory: bindings/python
        run: maturin build --release --out dist

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: bindings/python/dist/*

  publish-pypi:
    name: Publish PyPI package
    needs: build-python
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
