name: Task Checker

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

jobs:
  check-task-reference:
    name: Check Task Reference
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for task ID in PR title
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            PR_TITLE="${{ github.event.pull_request.title }}"
            if [[ ! "$PR_TITLE" =~ \[.*-[0-9]{3}\] ]]; then
              echo "⚠️ Warning: PR title should include task ID in format [TASK-ID]"
              echo "Example: [CF-001] Add Cloudflare function"
              exit 0  # Warning only, not blocking
            fi
          fi

      - name: Validate task exists in TASKS.md
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            PR_TITLE="${{ github.event.pull_request.title }}"
            TASK_ID=$(echo "$PR_TITLE" | grep -oP '\[\K[^\]]+' | head -1)
            if [ -n "$TASK_ID" ]; then
              if ! grep -q "**ID:** \`$TASK_ID\`" TASKS.md; then
                echo "❌ Task ID $TASK_ID not found in TASKS.md"
                exit 1
              else
                echo "✅ Task ID $TASK_ID found in TASKS.md"
              fi
            fi
          fi

  check-code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Check formatting
        run: cargo fmt --check

      - name: Run clippy
        run: cargo clippy -- -D warnings

      - name: Run tests
        run: cargo test

      - name: Check for new dependencies
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin main:main
            NEW_DEPS=$(git diff main...HEAD -- Cargo.toml | grep -E "^\+.*=" | grep -v "version\|features\|optional" || true)
            if [ -n "$NEW_DEPS" ]; then
              echo "⚠️ Warning: New dependencies detected. Ensure they are:"
              echo "  - Optional (behind feature flags)"
              echo "  - Dev-dependencies (for testing/benchmarking)"
              echo "  - Or justified in PR description"
              echo ""
              echo "New dependencies:"
              echo "$NEW_DEPS"
            fi
          fi
