name: Publish to crates.io

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  publish:
    name: Publish crate
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Update package versions to match tag
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          WORKSPACE_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          NODE_VERSION=$(node -p "require('./bindings/node/package.json').version")
          PYTHON_VERSION=$(python - <<'PY'
          import pathlib
          import re
          text = pathlib.Path("bindings/python/pyproject.toml").read_text()
          match = re.search(r'^version = "(.*)"$', text, flags=re.M)
          print(match.group(1))
          PY
          )
          
          echo "ðŸ“¦ Tag version: $TAG_VERSION"
          echo "ðŸ“¦ Workspace version: $WORKSPACE_VERSION"
          echo "ðŸ“¦ Node version: $NODE_VERSION"
          echo "ðŸ“¦ Python version: $PYTHON_VERSION"
          
          if [ "$TAG_VERSION" != "$WORKSPACE_VERSION" ] || [ "$TAG_VERSION" != "$NODE_VERSION" ] || [ "$TAG_VERSION" != "$PYTHON_VERSION" ]; then
            echo "ðŸ”„ Updating package versions to $TAG_VERSION"
            sed -i "0,/^version = \".*\"/s//version = \"$TAG_VERSION\"/" Cargo.toml

            python -c "import json,pathlib,re; version=pathlib.Path('Cargo.toml').read_text().split('version = \\\"', 1)[1].split('\\\"', 1)[0]; package_json=pathlib.Path('bindings/node/package.json'); data=json.loads(package_json.read_text()); data['version']=version; optional=data.get('optionalDependencies', {}); optional.update({key: version for key in optional}); package_json.write_text(json.dumps(data, indent=2) + '\\n'); pyproject=pathlib.Path('bindings/python/pyproject.toml'); text=pyproject.read_text(); text=re.sub(r'^version = \\\".*\\\"$', f'version = \\\"{version}\\\"', text, count=1, flags=re.M); pyproject.write_text(text)"
            
            # Update Cargo.lock to reflect the version change
            cargo check -p redstr
            
            # Configure git
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # Commit and push the version update
            git add Cargo.toml Cargo.lock bindings/node/package.json bindings/python/pyproject.toml
            git commit -m "chore: bump version to $TAG_VERSION for release"
            git push origin ${{ github.event.repository.default_branch }}
            
            echo "âœ… Version updated and committed"
          else
            echo "âœ… Version already matches tag"
          fi

      - name: Authenticate with crates.io (Trusted Publishing)
        id: auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish redstr to crates.io
        run: cargo publish -p redstr --all-features
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
